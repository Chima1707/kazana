#!/usr/bin/env node

var Kazana = require('../index')
var options = require('minimist')(process.argv.slice(2))
var getConfig = require('kazana-config')
var main = require(process.cwd())
var spawnPouchdbServer = require('spawn-pouchdb-server')

var corePlugins = require('../lib/core-plugins')
var plugins = corePlugins.concat(main.plugins || [])
var findWhere = require('lodash/collection/findWhere')
var pluck = require('lodash/collection/pluck')

var config = getConfig(main)

if (options.only) {
  var service = findWhere(plugins, {name: options.only})
  if (!service) {
    console.log('Unknown service: "%s". (%s)', options.only, pluck(plugins, 'name').join(', '))
    process.exit(1)
  }

  options.bare = true
}

if (config.backend.name === 'couchdb') {
  console.log('Connected to CouchDB at %s', config.backend.location)
  startKazana()
} else {
  if (options.bare) {
    console.error('Must set backend.name="couchdb" & backend.location="http://my.couch.com:5984" when starting with --bare or --only=')
    process.exit(1)
  }
  console.log('backend.location not set, starting PouchDB Server at %s ...', config.backend.port)

  spawnPouchdbServer({
    port: parseInt(config.backend.port, 10),
    backend: {
      name: config.backend.name,
      location: config.backend.location
    },
    log: {
      file: config.backend.log.file,
      level: config.backend.log.level
    },
    config: {
      file: config.backend.config.file
    }
  }, function (error) {
    if (error) throw error

    startKazana()
  })
}

function startKazana () {
  var config = service || main
  if (options.port) {
    config.port = parseInt(options.port, 10)
  }

  var kazana = new Kazana(config, {
    // if set to true, core modules like the kazana-raw-data do not get loaded
    bare: options.bare
  })

  kazana.start(function () {
    console.log('Server running at %s', kazana.info.uri)
  })
}
